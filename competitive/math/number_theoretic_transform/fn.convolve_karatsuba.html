<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="API documentation for the Rust `convolve_karatsuba` fn in crate `competitive`."><title>convolve_karatsuba in competitive::math::number_theoretic_transform - Rust</title><script>if(window.location.protocol!=="file:")document.head.insertAdjacentHTML("beforeend","SourceSerif4-Regular-6b053e98.ttf.woff2,FiraSans-Italic-81dc35de.woff2,FiraSans-Regular-0fe48ade.woff2,FiraSans-MediumItalic-ccf7e434.woff2,FiraSans-Medium-e1aa3f0a.woff2,SourceCodePro-Regular-8badfe75.ttf.woff2,SourceCodePro-Semibold-aa29a496.ttf.woff2".split(",").map(f=>`<link rel="preload" as="font" type="font/woff2"href="../../../static.files/${f}">`).join(""))</script><link rel="stylesheet" href="../../../static.files/normalize-9960930a.css"><link rel="stylesheet" href="../../../static.files/rustdoc-2eb46af5.css"><meta name="rustdoc-vars" data-root-path="../../../" data-static-root-path="../../../static.files/" data-current-crate="competitive" data-themes="" data-resource-suffix="" data-rustdoc-version="1.94.0-nightly (7ecabfaaf 2026-01-03)" data-channel="nightly" data-search-js="search-9e2438ea.js" data-stringdex-js="stringdex-b897f86f.js" data-settings-js="settings-c38705f0.js" ><script src="../../../static.files/storage-e2aeef58.js"></script><script defer src="sidebar-items.js"></script><script defer src="../../../static.files/main-7bab91a1.js"></script><script defer src="../../../static.files/scrape-examples-2bbcccac.js"></script><noscript><link rel="stylesheet" href="../../../static.files/noscript-ffcac47a.css"></noscript><link rel="alternate icon" type="image/png" href="../../../static.files/favicon-32x32-eab170b8.png"><link rel="icon" type="image/svg+xml" href="../../../static.files/favicon-044be391.svg"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css"
  integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.js"
  integrity="sha384-g7c+Jr9ZivxKLnZTDUhnkOnsh30B4H0rpLUpJ4jAIKs4fnJI+sEnkvrMWph2EDg4" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/contrib/auto-render.min.js"
  integrity="sha384-mll67QQFJfxn0IYznZYonOWZ644AWYC+Pt2cHqMaRhXVrursRwvLnLaebdGIlYNa" crossorigin="anonymous"></script>
<script>
  document.addEventListener("DOMContentLoaded", () => {
    renderMathInElement(document.body, {
      delimiters: [
        { left: "$$", right: "$$", display: true },
        { left: "$", right: "$", display: false }
      ]
    });
  });
</script>
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const parser = new DOMParser();
    const parse = s => parser.parseFromString(s, "text/html").body.firstChild;

    const addArchiveLinkSetting = () => {
      const settings = document.querySelector("#settings .settings");
      if (!settings) return;
      if (document.getElementById("generate-hidden-archive-link")) return;

      const checked = localStorage.getItem("generate-hidden-archive-link") === "true";
      const archiveLinkSetting = parse(`<div class="setting-line"><label class="setting-check"><input type="checkbox" id="generate-hidden-archive-link" ${checked ? "checked" : ""} /><span>Generate hidden archive link</span></label></div>`);
      settings.appendChild(archiveLinkSetting);
      document.getElementById("generate-hidden-archive-link").addEventListener("change", e => {
        if (e.target.checked) {
          localStorage.setItem("generate-hidden-archive-link", "true");
        } else {
          localStorage.removeItem("generate-hidden-archive-link");
        }
      });
    };
    addArchiveLinkSetting();
    const settingsMenu = document.querySelector("#settings-menu a");
    settingsMenu?.addEventListener("click", addArchiveLinkSetting);

    const addArchiveLink = () => {
      if (localStorage.getItem("generate-hidden-archive-link") !== "true") return;
      const subHeading = document.querySelector("#main-content .main-heading .sub-heading");
      const itemName = document.querySelector("#main-content .main-heading h1 span")?.textContent;
      const isCompetitive = document.querySelector("#main-content .main-heading .rustdoc-breadcrumbs a")?.textContent?.startsWith("competitive");
      if (!itemName || !isCompetitive) return;
      const archiveLink = parse(`<a class="src" href="https://github.com/search?q=repo%3Ato-omer%2Fcompetitive_archive+${itemName}&type=code">Archives</a>`);
      subHeading.appendChild(archiveLink);
    };
    addArchiveLink();
  });
</script>

</head><body class="rustdoc fn"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><rustdoc-topbar><h2><a href="#">convolve_karatsuba</a></h2></rustdoc-topbar><nav class="sidebar"><div class="sidebar-crate"><h2><a href="../../../competitive/index.html">competitive</a><span class="version">0.1.0</span></h2></div><div class="sidebar-elems"><div id="rustdoc-modnav"><h2><a href="index.html">In competitive::<wbr>math::<wbr>number_<wbr>theoretic_<wbr>transform</a></h2></div></div></nav><div class="sidebar-resizer" title="Drag to resize sidebar"></div><main><div class="width-limiter"><section id="main-content" class="content"><div class="main-heading"><div class="rustdoc-breadcrumbs"><a href="../../index.html">competitive</a>::<wbr><a href="../index.html">math</a>::<wbr><a href="index.html">number_theoretic_transform</a></div><h1>Function <span class="fn">convolve_<wbr>karatsuba</span>&nbsp;<button id="copy-path" title="Copy item path to clipboard">Copy item path</button></h1><rustdoc-toolbar></rustdoc-toolbar><span class="sub-heading"><a class="src" href="../../../src/competitive/math/number_theoretic_transform.rs.html#840-886">Source</a> </span></div><pre class="rust item-decl"><code>fn convolve_karatsuba&lt;T&gt;(a: &amp;<a class="primitive" href="https://doc.rust-lang.org/nightly/std/primitive.slice.html">[T]</a>, b: &amp;<a class="primitive" href="https://doc.rust-lang.org/nightly/std/primitive.slice.html">[T]</a>) -&gt; <a class="struct" href="https://doc.rust-lang.org/nightly/alloc/vec/struct.Vec.html" title="struct alloc::vec::Vec">Vec</a>&lt;T&gt;<div class="where">where
    T: <a class="trait" href="https://doc.rust-lang.org/nightly/core/marker/trait.Copy.html" title="trait core::marker::Copy">Copy</a> + <a class="trait" href="../../num/trait.Zero.html" title="trait competitive::num::Zero">Zero</a> + <a class="trait" href="https://doc.rust-lang.org/nightly/core/ops/arith/trait.AddAssign.html" title="trait core::ops::arith::AddAssign">AddAssign</a>&lt;T&gt; + <a class="trait" href="https://doc.rust-lang.org/nightly/core/ops/arith/trait.SubAssign.html" title="trait core::ops::arith::SubAssign">SubAssign</a>&lt;T&gt; + <a class="trait" href="https://doc.rust-lang.org/nightly/core/ops/arith/trait.Mul.html" title="trait core::ops::arith::Mul">Mul</a>&lt;Output = T&gt;,</div></code></pre><div class="docblock scraped-example-list"><span></span><h5 id="scraped-examples"><a href="#scraped-examples">Examples found in repository</a><a class="scrape-help" href="../../../scrape-examples-help.html">?</a></h5><div class="scraped-example" data-locs="[[[18,18],&#34;../../../src/competitive/math/number_theoretic_transform.rs.html#858&#34;,&#34;line 858&#34;],[[19,19],&#34;../../../src/competitive/math/number_theoretic_transform.rs.html#859&#34;,&#34;line 859&#34;],[[28,28],&#34;../../../src/competitive/math/number_theoretic_transform.rs.html#868&#34;,&#34;line 868&#34;],[[79,79],&#34;../../../src/competitive/math/number_theoretic_transform.rs.html#919&#34;,&#34;line 919&#34;],[[185,185],&#34;../../../src/competitive/math/number_theoretic_transform.rs.html#1025&#34;,&#34;line 1025&#34;],[[269,269],&#34;../../../src/competitive/math/number_theoretic_transform.rs.html#1109&#34;,&#34;line 1109&#34;]]"><div class="scraped-example-title">crates/competitive/src/math/number_theoretic_transform.rs (<a href="../../../src/competitive/math/number_theoretic_transform.rs.html#858">line 858</a>)</div><div class="example-wrap digits-4"><pre class="rust"><code><span data-nosnippet>840</span><span class="kw">fn </span>convolve_karatsuba&lt;T&gt;(a: <span class="kw-2">&amp;</span>[T], b: <span class="kw-2">&amp;</span>[T]) -&gt; Vec&lt;T&gt;
<span data-nosnippet>841</span><span class="kw">where
<span data-nosnippet>842</span>    </span>T: Copy + Zero + AddAssign&lt;T&gt; + SubAssign&lt;T&gt; + Mul&lt;Output = T&gt;,
<span data-nosnippet>843</span>{
<span data-nosnippet>844</span>    <span class="kw">if </span>a.len().min(b.len()) &lt;= <span class="number">30 </span>{
<span data-nosnippet>845</span>        <span class="kw">return </span>convolve_naive(a, b);
<span data-nosnippet>846</span>    }
<span data-nosnippet>847</span>    <span class="kw">let </span>m = a.len().max(b.len()).div_ceil(<span class="number">2</span>);
<span data-nosnippet>848</span>    <span class="kw">let </span>(a0, a1) = <span class="kw">if </span>a.len() &lt;= m {
<span data-nosnippet>849</span>        (a, <span class="kw-2">&amp;</span>[][..])
<span data-nosnippet>850</span>    } <span class="kw">else </span>{
<span data-nosnippet>851</span>        a.split_at(m)
<span data-nosnippet>852</span>    };
<span data-nosnippet>853</span>    <span class="kw">let </span>(b0, b1) = <span class="kw">if </span>b.len() &lt;= m {
<span data-nosnippet>854</span>        (b, <span class="kw-2">&amp;</span>[][..])
<span data-nosnippet>855</span>    } <span class="kw">else </span>{
<span data-nosnippet>856</span>        b.split_at(m)
<span data-nosnippet>857</span>    };
<span data-nosnippet>858</span>    <span class="kw">let </span>f00 = <span class="highlight focus">convolve_karatsuba</span>(a0, b0);
<span data-nosnippet>859</span>    <span class="kw">let </span>f11 = <span class="highlight">convolve_karatsuba</span>(a1, b1);
<span data-nosnippet>860</span>    <span class="kw">let </span><span class="kw-2">mut </span>a0a1 = a0.to_vec();
<span data-nosnippet>861</span>    <span class="kw">for </span>(a0a1, <span class="kw-2">&amp;</span>a1) <span class="kw">in </span>a0a1.iter_mut().zip(a1) {
<span data-nosnippet>862</span>        <span class="kw-2">*</span>a0a1 += a1;
<span data-nosnippet>863</span>    }
<span data-nosnippet>864</span>    <span class="kw">let </span><span class="kw-2">mut </span>b0b1 = b0.to_vec();
<span data-nosnippet>865</span>    <span class="kw">for </span>(b0b1, <span class="kw-2">&amp;</span>b1) <span class="kw">in </span>b0b1.iter_mut().zip(b1) {
<span data-nosnippet>866</span>        <span class="kw-2">*</span>b0b1 += b1;
<span data-nosnippet>867</span>    }
<span data-nosnippet>868</span>    <span class="kw">let </span><span class="kw-2">mut </span>f01 = <span class="highlight">convolve_karatsuba</span>(<span class="kw-2">&amp;</span>a0a1, <span class="kw-2">&amp;</span>b0b1);
<span data-nosnippet>869</span>    <span class="kw">for </span>(f01, <span class="kw-2">&amp;</span>f00) <span class="kw">in </span>f01.iter_mut().zip(<span class="kw-2">&amp;</span>f00) {
<span data-nosnippet>870</span>        <span class="kw-2">*</span>f01 -= f00;
<span data-nosnippet>871</span>    }
<span data-nosnippet>872</span>    <span class="kw">for </span>(f01, <span class="kw-2">&amp;</span>f11) <span class="kw">in </span>f01.iter_mut().zip(<span class="kw-2">&amp;</span>f11) {
<span data-nosnippet>873</span>        <span class="kw-2">*</span>f01 -= f11;
<span data-nosnippet>874</span>    }
<span data-nosnippet>875</span>    <span class="kw">let </span><span class="kw-2">mut </span>c = <span class="macro">vec!</span>[T::zero(); a.len() + b.len() - <span class="number">1</span>];
<span data-nosnippet>876</span>    <span class="kw">for </span>(c, <span class="kw-2">&amp;</span>f00) <span class="kw">in </span>c.iter_mut().zip(<span class="kw-2">&amp;</span>f00) {
<span data-nosnippet>877</span>        <span class="kw-2">*</span>c += f00;
<span data-nosnippet>878</span>    }
<span data-nosnippet>879</span>    <span class="kw">for </span>(c, <span class="kw-2">&amp;</span>f01) <span class="kw">in </span>c[m..].iter_mut().zip(<span class="kw-2">&amp;</span>f01) {
<span data-nosnippet>880</span>        <span class="kw-2">*</span>c += f01;
<span data-nosnippet>881</span>    }
<span data-nosnippet>882</span>    <span class="kw">for </span>(c, <span class="kw-2">&amp;</span>f11) <span class="kw">in </span>c[m &lt;&lt; <span class="number">1</span>..].iter_mut().zip(<span class="kw-2">&amp;</span>f11) {
<span data-nosnippet>883</span>        <span class="kw-2">*</span>c += f11;
<span data-nosnippet>884</span>    }
<span data-nosnippet>885</span>    c
<span data-nosnippet>886</span>}
<span data-nosnippet>887</span>
<span data-nosnippet>888</span><span class="kw">impl</span>&lt;M&gt; ConvolveSteps <span class="kw">for </span>Convolve&lt;M&gt;
<span data-nosnippet>889</span><span class="kw">where
<span data-nosnippet>890</span>    </span>M: Montgomery32NttModulus,
<span data-nosnippet>891</span>{
<span data-nosnippet>892</span>    <span class="kw">type </span>T = Vec&lt;MInt&lt;M&gt;&gt;;
<span data-nosnippet>893</span>    <span class="kw">type </span>F = Vec&lt;MInt&lt;M&gt;&gt;;
<span data-nosnippet>894</span>    <span class="kw">fn </span>length(t: <span class="kw-2">&amp;</span><span class="self">Self</span>::T) -&gt; usize {
<span data-nosnippet>895</span>        t.len()
<span data-nosnippet>896</span>    }
<span data-nosnippet>897</span>    <span class="kw">fn </span>transform(<span class="kw-2">mut </span>t: <span class="self">Self</span>::T, len: usize) -&gt; <span class="self">Self</span>::F {
<span data-nosnippet>898</span>        t.resize_with(len.max(<span class="number">1</span>).next_power_of_two(), Zero::zero);
<span data-nosnippet>899</span>        ntt(<span class="kw-2">&amp;mut </span>t);
<span data-nosnippet>900</span>        t
<span data-nosnippet>901</span>    }
<span data-nosnippet>902</span>    <span class="kw">fn </span>inverse_transform(<span class="kw-2">mut </span>f: <span class="self">Self</span>::F, len: usize) -&gt; <span class="self">Self</span>::T {
<span data-nosnippet>903</span>        intt(<span class="kw-2">&amp;mut </span>f);
<span data-nosnippet>904</span>        f.truncate(len);
<span data-nosnippet>905</span>        <span class="kw">let </span>inv = MInt::from(len.max(<span class="number">1</span>).next_power_of_two() <span class="kw">as </span>u32).inv();
<span data-nosnippet>906</span>        <span class="kw">for </span>f <span class="kw">in </span>f.iter_mut() {
<span data-nosnippet>907</span>            <span class="kw-2">*</span>f <span class="kw-2">*</span>= inv;
<span data-nosnippet>908</span>        }
<span data-nosnippet>909</span>        f
<span data-nosnippet>910</span>    }
<span data-nosnippet>911</span>    <span class="kw">fn </span>multiply(f: <span class="kw-2">&amp;mut </span><span class="self">Self</span>::F, g: <span class="kw-2">&amp;</span><span class="self">Self</span>::F) {
<span data-nosnippet>912</span>        <span class="macro">assert_eq!</span>(f.len(), g.len());
<span data-nosnippet>913</span>        <span class="kw">for </span>(f, g) <span class="kw">in </span>f.iter_mut().zip(g.iter()) {
<span data-nosnippet>914</span>            <span class="kw-2">*</span>f <span class="kw-2">*</span>= <span class="kw-2">*</span>g;
<span data-nosnippet>915</span>        }
<span data-nosnippet>916</span>    }
<span data-nosnippet>917</span>    <span class="kw">fn </span>convolve(<span class="kw-2">mut </span>a: <span class="self">Self</span>::T, <span class="kw-2">mut </span>b: <span class="self">Self</span>::T) -&gt; <span class="self">Self</span>::T {
<span data-nosnippet>918</span>        <span class="kw">if </span><span class="self">Self</span>::length(<span class="kw-2">&amp;</span>a).max(<span class="self">Self</span>::length(<span class="kw-2">&amp;</span>b)) &lt;= <span class="number">100 </span>{
<span data-nosnippet>919</span>            <span class="kw">return </span><span class="highlight">convolve_karatsuba</span>(<span class="kw-2">&amp;</span>a, <span class="kw-2">&amp;</span>b);
<span data-nosnippet>920</span>        }
<span data-nosnippet>921</span>        <span class="kw">if </span><span class="self">Self</span>::length(<span class="kw-2">&amp;</span>a).min(<span class="self">Self</span>::length(<span class="kw-2">&amp;</span>b)) &lt;= <span class="number">60 </span>{
<span data-nosnippet>922</span>            <span class="kw">return </span>convolve_naive(<span class="kw-2">&amp;</span>a, <span class="kw-2">&amp;</span>b);
<span data-nosnippet>923</span>        }
<span data-nosnippet>924</span>        <span class="kw">let </span>len = (<span class="self">Self</span>::length(<span class="kw-2">&amp;</span>a) + <span class="self">Self</span>::length(<span class="kw-2">&amp;</span>b)).saturating_sub(<span class="number">1</span>);
<span data-nosnippet>925</span>        <span class="kw">let </span>size = len.max(<span class="number">1</span>).next_power_of_two();
<span data-nosnippet>926</span>        <span class="kw">if </span>len &lt;= size / <span class="number">2 </span>+ <span class="number">2 </span>{
<span data-nosnippet>927</span>            <span class="kw">let </span>xa = a.pop().unwrap();
<span data-nosnippet>928</span>            <span class="kw">let </span>xb = b.pop().unwrap();
<span data-nosnippet>929</span>            <span class="kw">let </span><span class="kw-2">mut </span>c = <span class="macro">vec!</span>[MInt::&lt;M&gt;::zero(); len];
<span data-nosnippet>930</span>            <span class="kw-2">*</span>c.last_mut().unwrap() = xa * xb;
<span data-nosnippet>931</span>            <span class="kw">for </span>(a, c) <span class="kw">in </span>a.iter().zip(<span class="kw-2">&amp;mut </span>c[b.len()..]) {
<span data-nosnippet>932</span>                <span class="kw-2">*</span>c += <span class="kw-2">*</span>a * xb;
<span data-nosnippet>933</span>            }
<span data-nosnippet>934</span>            <span class="kw">for </span>(b, c) <span class="kw">in </span>b.iter().zip(<span class="kw-2">&amp;mut </span>c[a.len()..]) {
<span data-nosnippet>935</span>                <span class="kw-2">*</span>c += <span class="kw-2">*</span>b * xa;
<span data-nosnippet>936</span>            }
<span data-nosnippet>937</span>            <span class="kw">let </span>d = <span class="self">Self</span>::convolve(a, b);
<span data-nosnippet>938</span>            <span class="kw">for </span>(d, c) <span class="kw">in </span>d.into_iter().zip(<span class="kw-2">&amp;mut </span>c) {
<span data-nosnippet>939</span>                <span class="kw-2">*</span>c += d;
<span data-nosnippet>940</span>            }
<span data-nosnippet>941</span>            <span class="kw">return </span>c;
<span data-nosnippet>942</span>        }
<span data-nosnippet>943</span>        <span class="kw">let </span>same = a == b;
<span data-nosnippet>944</span>        <span class="kw">let </span><span class="kw-2">mut </span>a = <span class="self">Self</span>::transform(a, len);
<span data-nosnippet>945</span>        <span class="kw">if </span>same {
<span data-nosnippet>946</span>            <span class="kw">for </span>a <span class="kw">in </span>a.iter_mut() {
<span data-nosnippet>947</span>                <span class="kw-2">*</span>a <span class="kw-2">*</span>= <span class="kw-2">*</span>a;
<span data-nosnippet>948</span>            }
<span data-nosnippet>949</span>        } <span class="kw">else </span>{
<span data-nosnippet>950</span>            <span class="kw">let </span>b = <span class="self">Self</span>::transform(b, len);
<span data-nosnippet>951</span>            <span class="self">Self</span>::multiply(<span class="kw-2">&amp;mut </span>a, <span class="kw-2">&amp;</span>b);
<span data-nosnippet>952</span>        }
<span data-nosnippet>953</span>        <span class="self">Self</span>::inverse_transform(a, len)
<span data-nosnippet>954</span>    }
<span data-nosnippet>955</span>}
<span data-nosnippet>956</span>
<span data-nosnippet>957</span><span class="kw">type </span>MVec&lt;M&gt; = Vec&lt;MInt&lt;M&gt;&gt;;
<span data-nosnippet>958</span><span class="kw">impl</span>&lt;M, N1, N2, N3&gt; ConvolveSteps <span class="kw">for </span>Convolve&lt;(M, (N1, N2, N3))&gt;
<span data-nosnippet>959</span><span class="kw">where
<span data-nosnippet>960</span>    </span>M: MIntConvert + MIntConvert&lt;u32&gt;,
<span data-nosnippet>961</span>    N1: Montgomery32NttModulus,
<span data-nosnippet>962</span>    N2: Montgomery32NttModulus,
<span data-nosnippet>963</span>    N3: Montgomery32NttModulus,
<span data-nosnippet>964</span>{
<span data-nosnippet>965</span>    <span class="kw">type </span>T = MVec&lt;M&gt;;
<span data-nosnippet>966</span>    <span class="kw">type </span>F = (MVec&lt;N1&gt;, MVec&lt;N2&gt;, MVec&lt;N3&gt;);
<span data-nosnippet>967</span>    <span class="kw">fn </span>length(t: <span class="kw-2">&amp;</span><span class="self">Self</span>::T) -&gt; usize {
<span data-nosnippet>968</span>        t.len()
<span data-nosnippet>969</span>    }
<span data-nosnippet>970</span>    <span class="kw">fn </span>transform(t: <span class="self">Self</span>::T, len: usize) -&gt; <span class="self">Self</span>::F {
<span data-nosnippet>971</span>        <span class="kw">let </span>npot = len.max(<span class="number">1</span>).next_power_of_two();
<span data-nosnippet>972</span>        <span class="kw">let </span><span class="kw-2">mut </span>f = (
<span data-nosnippet>973</span>            MVec::&lt;N1&gt;::with_capacity(npot),
<span data-nosnippet>974</span>            MVec::&lt;N2&gt;::with_capacity(npot),
<span data-nosnippet>975</span>            MVec::&lt;N3&gt;::with_capacity(npot),
<span data-nosnippet>976</span>        );
<span data-nosnippet>977</span>        <span class="kw">for </span>t <span class="kw">in </span>t {
<span data-nosnippet>978</span>            f.<span class="number">0</span>.push(&lt;M <span class="kw">as </span>MIntConvert&lt;u32&gt;&gt;::into(t.inner()).into());
<span data-nosnippet>979</span>            f.<span class="number">1</span>.push(&lt;M <span class="kw">as </span>MIntConvert&lt;u32&gt;&gt;::into(t.inner()).into());
<span data-nosnippet>980</span>            f.<span class="number">2</span>.push(&lt;M <span class="kw">as </span>MIntConvert&lt;u32&gt;&gt;::into(t.inner()).into());
<span data-nosnippet>981</span>        }
<span data-nosnippet>982</span>        f.<span class="number">0</span>.resize_with(npot, Zero::zero);
<span data-nosnippet>983</span>        f.<span class="number">1</span>.resize_with(npot, Zero::zero);
<span data-nosnippet>984</span>        f.<span class="number">2</span>.resize_with(npot, Zero::zero);
<span data-nosnippet>985</span>        ntt(<span class="kw-2">&amp;mut </span>f.<span class="number">0</span>);
<span data-nosnippet>986</span>        ntt(<span class="kw-2">&amp;mut </span>f.<span class="number">1</span>);
<span data-nosnippet>987</span>        ntt(<span class="kw-2">&amp;mut </span>f.<span class="number">2</span>);
<span data-nosnippet>988</span>        f
<span data-nosnippet>989</span>    }
<span data-nosnippet>990</span>    <span class="kw">fn </span>inverse_transform(f: <span class="self">Self</span>::F, len: usize) -&gt; <span class="self">Self</span>::T {
<span data-nosnippet>991</span>        <span class="kw">let </span>t1 = MInt::&lt;N2&gt;::new(N1::get_mod()).inv();
<span data-nosnippet>992</span>        <span class="kw">let </span>m1 = MInt::&lt;M&gt;::from(N1::get_mod());
<span data-nosnippet>993</span>        <span class="kw">let </span>m1_3 = MInt::&lt;N3&gt;::new(N1::get_mod());
<span data-nosnippet>994</span>        <span class="kw">let </span>t2 = (m1_3 * MInt::&lt;N3&gt;::new(N2::get_mod())).inv();
<span data-nosnippet>995</span>        <span class="kw">let </span>m2 = m1 * MInt::&lt;M&gt;::from(N2::get_mod());
<span data-nosnippet>996</span>        Convolve::&lt;N1&gt;::inverse_transform(f.<span class="number">0</span>, len)
<span data-nosnippet>997</span>            .into_iter()
<span data-nosnippet>998</span>            .zip(Convolve::&lt;N2&gt;::inverse_transform(f.<span class="number">1</span>, <a href="https://doc.rust-lang.org/nightly/core/ops/arith/trait.Mul.html">len</a>))
<span data-nosnippet>999</span>            .zip(Convolve::&lt;N3&gt;::inverse_transform(f.<span class="number">2</span>, len))
<span data-nosnippet>1000</span>            .map(|((c1, c2), c3)| {
<span data-nosnippet>1001</span>                <span class="kw">let </span>d1 = c1.inner();
<span data-nosnippet>1002</span>                <span class="kw">let </span>d2 = ((c2 - MInt::&lt;N2&gt;::from(d1)) * t1).inner();
<span data-nosnippet>1003</span>                <span class="kw">let </span>x = MInt::&lt;N3&gt;::new(d1) + MInt::&lt;N3&gt;::new(d2) * m1_3;
<span data-nosnippet>1004</span>                <span class="kw">let </span>d3 = ((c3 - x) * t2).inner();
<span data-nosnippet>1005</span>                MInt::&lt;M&gt;::from(d1) + MInt::&lt;M&gt;::from(d2) * m1 + MInt::&lt;M&gt;::from(d3) * m2
<span data-nosnippet>1006</span>            })
<span data-nosnippet>1007</span>            .collect()
<span data-nosnippet>1008</span>    }
<span data-nosnippet>1009</span>    <span class="kw">fn </span>multiply(f: <span class="kw-2">&amp;mut </span><span class="self">Self</span>::F, g: <span class="kw-2">&amp;</span><span class="self">Self</span>::F) {
<span data-nosnippet>1010</span>        <span class="macro">assert_eq!</span>(f.<span class="number">0</span>.len(), g.<span class="number">0</span>.len());
<span data-nosnippet>1011</span>        <span class="macro">assert_eq!</span>(f.<span class="number">1</span>.len(), g.<span class="number">1</span>.len());
<span data-nosnippet>1012</span>        <span class="macro">assert_eq!</span>(f.<span class="number">2</span>.len(), g.<span class="number">2</span>.len());
<span data-nosnippet>1013</span>        <span class="kw">for </span>(f, g) <span class="kw">in </span>f.<span class="number">0</span>.iter_mut().zip(g.<span class="number">0</span>.iter()) {
<span data-nosnippet>1014</span>            <span class="kw-2">*</span>f <span class="kw-2">*</span>= <span class="kw-2">*</span>g;
<span data-nosnippet>1015</span>        }
<span data-nosnippet>1016</span>        <span class="kw">for </span>(f, g) <span class="kw">in </span>f.<span class="number">1</span>.iter_mut().zip(g.<span class="number">1</span>.iter()) {
<span data-nosnippet>1017</span>            <span class="kw-2">*</span>f <span class="kw-2">*</span>= <span class="kw-2">*</span>g;
<span data-nosnippet>1018</span>        }
<span data-nosnippet>1019</span>        <span class="kw">for </span>(f, g) <span class="kw">in </span>f.<span class="number">2</span>.iter_mut().zip(g.<span class="number">2</span>.iter()) {
<span data-nosnippet>1020</span>            <span class="kw-2">*</span>f <span class="kw-2">*</span>= <span class="kw-2">*</span>g;
<span data-nosnippet>1021</span>        }
<span data-nosnippet>1022</span>    }
<span data-nosnippet>1023</span>    <span class="kw">fn </span>convolve(a: <span class="self">Self</span>::T, b: <span class="self">Self</span>::T) -&gt; <span class="self">Self</span>::T {
<span data-nosnippet>1024</span>        <span class="kw">if </span><span class="self">Self</span>::length(<span class="kw-2">&amp;</span>a).max(<span class="self">Self</span>::length(<span class="kw-2">&amp;</span>b)) &lt;= <span class="number">300 </span>{
<span data-nosnippet>1025</span>            <span class="kw">return </span><span class="highlight">convolve_karatsuba</span>(<span class="kw-2">&amp;</span>a, <span class="kw-2">&amp;</span>b);
<span data-nosnippet>1026</span>        }
<span data-nosnippet>1027</span>        <span class="kw">if </span><span class="self">Self</span>::length(<span class="kw-2">&amp;</span>a).min(<span class="self">Self</span>::length(<span class="kw-2">&amp;</span>b)) &lt;= <span class="number">60 </span>{
<span data-nosnippet>1028</span>            <span class="kw">return </span>convolve_naive(<span class="kw-2">&amp;</span>a, <span class="kw-2">&amp;</span>b);
<span data-nosnippet>1029</span>        }
<span data-nosnippet>1030</span>        <span class="kw">let </span>len = (<span class="self">Self</span>::length(<span class="kw-2">&amp;</span>a) + <span class="self">Self</span>::length(<span class="kw-2">&amp;</span>b)).saturating_sub(<span class="number">1</span>);
<span data-nosnippet>1031</span>        <span class="kw">let </span><span class="kw-2">mut </span>a = <span class="self">Self</span>::transform(a, len);
<span data-nosnippet>1032</span>        <span class="kw">let </span>b = <span class="self">Self</span>::transform(b, len);
<span data-nosnippet>1033</span>        <span class="self">Self</span>::multiply(<span class="kw-2">&amp;mut </span>a, <span class="kw-2">&amp;</span>b);
<span data-nosnippet>1034</span>        <span class="self">Self</span>::inverse_transform(a, len)
<span data-nosnippet>1035</span>    }
<span data-nosnippet>1036</span>}
<span data-nosnippet>1037</span>
<span data-nosnippet>1038</span><span class="kw">impl</span>&lt;N1, N2, N3&gt; ConvolveSteps <span class="kw">for </span>Convolve&lt;(u64, (N1, N2, N3))&gt;
<span data-nosnippet>1039</span><span class="kw">where
<span data-nosnippet>1040</span>    </span>N1: Montgomery32NttModulus,
<span data-nosnippet>1041</span>    N2: Montgomery32NttModulus,
<span data-nosnippet>1042</span>    N3: Montgomery32NttModulus,
<span data-nosnippet>1043</span>{
<span data-nosnippet>1044</span>    <span class="kw">type </span>T = Vec&lt;u64&gt;;
<span data-nosnippet>1045</span>    <span class="kw">type </span>F = (MVec&lt;N1&gt;, MVec&lt;N2&gt;, MVec&lt;N3&gt;);
<span data-nosnippet>1046</span>
<span data-nosnippet>1047</span>    <span class="kw">fn </span>length(t: <span class="kw-2">&amp;</span><span class="self">Self</span>::T) -&gt; usize {
<span data-nosnippet>1048</span>        t.len()
<span data-nosnippet>1049</span>    }
<span data-nosnippet>1050</span>
<span data-nosnippet>1051</span>    <span class="kw">fn </span>transform(t: <span class="self">Self</span>::T, len: usize) -&gt; <span class="self">Self</span>::F {
<span data-nosnippet>1052</span>        <span class="kw">let </span>npot = len.max(<span class="number">1</span>).next_power_of_two();
<span data-nosnippet>1053</span>        <span class="kw">let </span><span class="kw-2">mut </span>f = (
<span data-nosnippet>1054</span>            MVec::&lt;N1&gt;::with_capacity(npot),
<span data-nosnippet>1055</span>            MVec::&lt;N2&gt;::with_capacity(npot),
<span data-nosnippet>1056</span>            MVec::&lt;N3&gt;::with_capacity(npot),
<span data-nosnippet>1057</span>        );
<span data-nosnippet>1058</span>        <span class="kw">for </span>t <span class="kw">in </span>t {
<span data-nosnippet>1059</span>            f.<span class="number">0</span>.push(t.into());
<span data-nosnippet>1060</span>            f.<span class="number">1</span>.push(t.into());
<span data-nosnippet>1061</span>            f.<span class="number">2</span>.push(t.into());
<span data-nosnippet>1062</span>        }
<span data-nosnippet>1063</span>        f.<span class="number">0</span>.resize_with(npot, Zero::zero);
<span data-nosnippet>1064</span>        f.<span class="number">1</span>.resize_with(npot, Zero::zero);
<span data-nosnippet>1065</span>        f.<span class="number">2</span>.resize_with(npot, Zero::zero);
<span data-nosnippet>1066</span>        ntt(<span class="kw-2">&amp;mut </span>f.<span class="number">0</span>);
<span data-nosnippet>1067</span>        ntt(<span class="kw-2">&amp;mut </span>f.<span class="number">1</span>);
<span data-nosnippet>1068</span>        ntt(<span class="kw-2">&amp;mut </span>f.<span class="number">2</span>);
<span data-nosnippet>1069</span>        f
<span data-nosnippet>1070</span>    }
<span data-nosnippet>1071</span>
<span data-nosnippet>1072</span>    <span class="kw">fn </span>inverse_transform(f: <span class="self">Self</span>::F, len: usize) -&gt; <span class="self">Self</span>::T {
<span data-nosnippet>1073</span>        <span class="kw">let </span>t1 = MInt::&lt;N2&gt;::new(N1::get_mod()).inv();
<span data-nosnippet>1074</span>        <span class="kw">let </span>m1 = N1::get_mod() <span class="kw">as </span>u64;
<span data-nosnippet>1075</span>        <span class="kw">let </span>m1_3 = MInt::&lt;N3&gt;::new(N1::get_mod());
<span data-nosnippet>1076</span>        <span class="kw">let </span>t2 = (m1_3 * MInt::&lt;N3&gt;::new(N2::get_mod())).inv();
<span data-nosnippet>1077</span>        <span class="kw">let </span>m2 = m1 * N2::get_mod() <span class="kw">as </span>u64;
<span data-nosnippet>1078</span>        Convolve::&lt;N1&gt;::inverse_transform(f.<span class="number">0</span>, len)
<span data-nosnippet>1079</span>            .into_iter()
<span data-nosnippet>1080</span>            .zip(Convolve::&lt;N2&gt;::inverse_transform(f.<span class="number">1</span>, len))
<span data-nosnippet>1081</span>            .zip(Convolve::&lt;N3&gt;::inverse_transform(f.<span class="number">2</span>, len))
<span data-nosnippet>1082</span>            .map(|((c1, c2), c3)| {
<span data-nosnippet>1083</span>                <span class="kw">let </span>d1 = c1.inner();
<span data-nosnippet>1084</span>                <span class="kw">let </span>d2 = ((c2 - MInt::&lt;N2&gt;::from(d1)) * t1).inner();
<span data-nosnippet>1085</span>                <span class="kw">let </span>x = MInt::&lt;N3&gt;::new(d1) + MInt::&lt;N3&gt;::new(d2) * m1_3;
<span data-nosnippet>1086</span>                <span class="kw">let </span>d3 = ((c3 - x) * t2).inner();
<span data-nosnippet>1087</span>                d1 <span class="kw">as </span>u64 + d2 <span class="kw">as </span>u64 * m1 + d3 <span class="kw">as </span>u64 * m2
<span data-nosnippet>1088</span>            })
<span data-nosnippet>1089</span>            .collect()
<span data-nosnippet>1090</span>    }
<span data-nosnippet>1091</span>
<span data-nosnippet>1092</span>    <span class="kw">fn </span>multiply(f: <span class="kw-2">&amp;mut </span><span class="self">Self</span>::F, g: <span class="kw-2">&amp;</span><span class="self">Self</span>::F) {
<span data-nosnippet>1093</span>        <span class="macro">assert_eq!</span>(f.<span class="number">0</span>.len(), g.<span class="number">0</span>.len());
<span data-nosnippet>1094</span>        <span class="macro">assert_eq!</span>(f.<span class="number">1</span>.len(), g.<span class="number">1</span>.len());
<span data-nosnippet>1095</span>        <span class="macro">assert_eq!</span>(f.<span class="number">2</span>.len(), <a href="#468">g</a>.<span class="number">2</span>.len());
<span data-nosnippet>1096</span>        <span class="kw">for </span>(f, g) <span class="kw">in </span>f.<span class="number">0</span>.iter_mut().zip(g.<span class="number">0</span>.iter()) {
<span data-nosnippet>1097</span>            <span class="kw-2">*</span>f <span class="kw-2">*</span>= <span class="kw-2">*</span>g;
<span data-nosnippet>1098</span>        }
<span data-nosnippet>1099</span>        <span class="kw">for </span>(f, g) <span class="kw">in </span>f.<span class="number">1</span>.iter_mut().zip(g.<span class="number">1</span>.iter()) {
<span data-nosnippet>1100</span>            <span class="kw-2">*</span>f <span class="kw-2">*</span>= <span class="kw-2">*</span>g;
<span data-nosnippet>1101</span>        }
<span data-nosnippet>1102</span>        <span class="kw">for </span>(f, g) <span class="kw">in </span>f.<span class="number">2</span>.iter_mut().zip(g.<span class="number">2</span>.iter()) {
<span data-nosnippet>1103</span>            <span class="kw-2">*</span>f <span class="kw-2">*</span>= <span class="kw-2">*</span>g;
<span data-nosnippet>1104</span>        }
<span data-nosnippet>1105</span>    }
<span data-nosnippet>1106</span>
<span data-nosnippet>1107</span>    <span class="kw">fn </span>convolve(a: <span class="self">Self</span>::T, b: <span class="self">Self</span>::T) -&gt; <span class="self">Self</span>::T {
<span data-nosnippet>1108</span>        <span class="kw">if </span><span class="self">Self</span>::length(<span class="kw-2">&amp;</span>a).max(<span class="self">Self</span>::length(<span class="kw-2">&amp;</span>b)) &lt;= <span class="number">300 </span>{
<span data-nosnippet>1109</span>            <span class="kw">return </span><span class="highlight">convolve_karatsuba</span>(<span class="kw-2">&amp;</span>a, <span class="kw-2">&amp;</span>b);
<span data-nosnippet>1110</span>        }
<span data-nosnippet>1111</span>        <span class="kw">if </span><span class="self">Self</span>::length(<span class="kw-2">&amp;</span>a).min(<span class="self">Self</span>::length(<span class="kw-2">&amp;</span>b)) &lt;= <span class="number">60 </span>{
<span data-nosnippet>1112</span>            <span class="kw">return </span>convolve_naive(<span class="kw-2">&amp;</span>a, <span class="kw-2">&amp;</span>b);
<span data-nosnippet>1113</span>        }
<span data-nosnippet>1114</span>        <span class="kw">let </span>len = (<span class="self">Self</span>::length(<span class="kw-2">&amp;</span>a) + <span class="self">Self</span>::length(<span class="kw-2">&amp;</span>b)).saturating_sub(<span class="number">1</span>);
<span data-nosnippet>1115</span>        <span class="kw">let </span><span class="kw-2">mut </span>a = <span class="self">Self</span>::transform(a, len);
<span data-nosnippet>1116</span>        <span class="kw">let </span>b = <span class="self">Self</span>::transform(b, len);
<span data-nosnippet>1117</span>        <span class="self">Self</span>::multiply(<span class="kw-2">&amp;mut </span>a, <span class="kw-2">&amp;</span>b);
<span data-nosnippet>1118</span>        <span class="self">Self</span>::inverse_transform(a, len)
<span data-nosnippet>1119</span>    }</code></pre></div></div></div></section></div></main></body></html>